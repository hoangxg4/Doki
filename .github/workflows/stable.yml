name: Build Stable APK

on:
  push:
    tags:
      - "*.*.*"  # ch·ªâ ch·∫°y khi c√≥ tag d·∫°ng 1.0.0, 2.3.1...
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ L·∫•y code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ C√†i Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ C·∫•p quy·ªÅn ch·∫°y gradlew
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4Ô∏è‚É£ Build APK Release
      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace

      # 5Ô∏è‚É£ Sign APK
      - name: Sign APK
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "35.0.0"

      # 6Ô∏è‚É£ ƒê·ªïi t√™n file APK sau khi sign
      - name: Rename Signed APK
        run: |
          cd app/build/outputs/apk/release
          echo "==> Files in release folder:"
          ls -al
          APK_FILE=$(ls *-signed.apk | head -n 1)
          if [ -z "$APK_FILE" ]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y file APK n√†o sau khi sign!"
            exit 1
          fi
          NEW_NAME="doki-stable-$(head /dev/urandom | tr -dc a-z0-9 | head -c 6).apk"
          mv "$APK_FILE" "$NEW_NAME"
          echo "‚úÖ ƒê√£ ƒë·ªïi t√™n $APK_FILE ‚Üí $NEW_NAME"
          echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV

      # 7Ô∏è‚É£ X√≥a b·∫£n stable c≈© (n·∫øu c√≥)
      - name: Delete old stable release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh release delete stable --yes || true

      # 8Ô∏è‚É£ T·∫°o b·∫£n release m·ªõi
      - name: Create new stable release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          cd app/build/outputs/apk/release
          VERSION=${GITHUB_REF_NAME}
          gh release create stable "$APK_NAME" \
            --title "Stable Release ${VERSION}" \
            --notes "üè∑Ô∏è Phi√™n b·∫£n ch√≠nh th·ª©c ${VERSION}\nüöÄ Commit: $(git rev-parse --short HEAD)" \
            --latest
