name: Build Beta APK

on:
  push:
    branches:
      - "main"
    tags-ignore:
      - "*.*.*" # B·ªè qua khi c√≥ tag (ƒë·ªÉ tr√°nh tr√πng stable build)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ L·∫•y code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      # 2Ô∏è‚É£ C√†i JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ C·∫•p quy·ªÅn ch·∫°y gradlew
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4Ô∏è‚É£ Build Debug APK
      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      # 5Ô∏è‚É£ K√Ω APK (gi·ªëng stable)
      - name: Sign Debug APK
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/apk/debug
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "35.0.0"

      # 6Ô∏è‚É£ ƒê·ªïi t√™n file APK sau khi k√Ω
      - name: Rename Signed APK
        run: |
          cd app/build/outputs/apk/debug
          echo "==> Files in debug folder:"
          ls -al
          APK_FILE=$(ls *-signed.apk | head -n 1)
          if [ -z "$APK_FILE" ]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y file APK n√†o sau khi k√Ω!"
            exit 1
          fi
          NEW_NAME="doki-beta-$(head /dev/urandom | tr -dc a-z0-9 | head -c 6).apk"
          mv "$APK_FILE" "$NEW_NAME"
          echo "‚úÖ ƒê√£ ƒë·ªïi t√™n $APK_FILE ‚Üí $NEW_NAME"
          echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV

      # 7Ô∏è‚É£ X√≥a b·∫£n beta c≈© (n·∫øu c√≥)
      - name: Delete old beta release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh release delete beta --yes || true

      # 8Ô∏è‚É£ T·∫°o b·∫£n beta m·ªõi
      - name: Create new beta release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          cd app/build/outputs/apk/debug
          COMMIT=$(git rev-parse --short HEAD)
          gh release create beta "$APK_NAME" \
            --title "Beta Build ${COMMIT}" \
            --notes "üß™ B·∫£n th·ª≠ nghi·ªám m·ªõi nh·∫•t (beta)\nCommit: ${COMMIT}\nBranch: main" \
            --prerelease
