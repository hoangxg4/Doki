name: Build Beta APK

on:
  push:
    branches:
      - "main"
    tags-ignore:
      - "*.*.*" # Bỏ qua khi có tag (để tránh trùng stable build)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug

      - name: Rename APK
        run: |
          cd app/build/outputs/apk/debug
          NEW_NAME="doki-beta-$(head /dev/urandom | tr -dc a-z0-9 | head -c 6).apk"
          mv app-debug.apk "$NEW_NAME"
          echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV

      - name: Delete old beta release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh release delete beta --yes || true

      - name: Create new beta release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          cd app/build/outputs/apk/debug
          COMMIT=$(git rev-parse --short HEAD)
          gh release create beta "$APK_NAME" \
            --title "Beta Build ${COMMIT}" \
            --notes "🧪 Bản thử nghiệm mới nhất (beta)\nCommit: ${COMMIT}\nBranch: main" \
            --prerelease
